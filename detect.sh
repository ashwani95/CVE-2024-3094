#! /bin/bash
# Modified to run both checks using xxd or od as fallback

set -eu

# Find path to liblzma used by sshd
path_cve_2024_3094="$(ldd $(which sshd 2>/dev/null) | grep liblzma | grep -oP '/[^ ]+')"

# Check if the path was found
if [ -z "$path_cve_2024_3094" ]; then
  echo "liblzma not found in the sshd dependencies. Your system might not be vulnerable or sshd is not installed."
  exit 1
fi

echo 'Check one: does it even exist?'
# Check if the file exists
if [ ! -f "$path_cve_2024_3094" ]; then
  echo "The liblzma file does not exist at the detected path: $path_cve_2024_3094. Probably not vulnerable."
  exit 1
fi

echo 'Check 2: function signature'

# Function to check for vulnerability using xxd or od
check_vulnerability() {
  local path="$1"
  
  # Check if xxd is available
  if command -v xxd > /dev/null; then
    xxd -p "$path" | tr -d '\n' | grep -q 'f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410' && echo "probably vulnerable" || echo "probably not vulnerable"
  elif command -v od > /dev/null; then
    # Use od as a fallback
    od -v -t x1 -An "$path" | tr -d ' \n' | grep -q 'f30f1efa554889f54c89ce5389fb81e7000000804883ec28488954241848894c2410' && echo "probably vulnerable" || echo "probably not vulnerable"
  else
    echo "Neither xxd nor od is available on this system. Cannot perform signature check."
    exit 1
  fi
}

check_vulnerability "$path_cve_2024_3094"
